# charlie
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: charlie-vector-config
  namespace: sidechains-substrate-poc-3
data:
  vector.toml: |
    [api]
    enabled = true
    address = "0.0.0.0:8686"
    [sources.log_file]
    type = "file"
    include = ["/var/log/*.log"]
    # [sinks.prometheus]
    # type = "prometheus_exporter"
    # inputs = [ "my-source-or-transform-id" ]
    [sinks.console]
    inputs = ["log_file"]
    target = "stdout"
    type = "console"
    encoding.codec = "json"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: charlie-secrets
  namespace: sidechains-substrate-poc-3
data:
  postgres_db: "cexplorer"
  postgres_user: "postgres"
  postgres_password: "password123"
---
apiVersion: v1
kind: Pod
metadata:
  name: charlie
  namespace: sidechains-substrate-poc-3
  labels:
    app: charlie
    node: charlie
spec:
  replicas: 1
  selector:
    matchLabels:
      app: charlie
  template:
    metadata:
      labels:
        app: charlie
    spec:
      containers:
        - name: charlie-cardano-node
          image: inputoutput/cardano-node:8.0.0 
          env:
            - name: NETWORK
              value: "preview"
            - name: CARDANO_NODE_SOCKET_PATH
              value: /ipc/node.socket
          volumeMounts:
            - name: ipc
              mountPath: /ipc
            - name: data
              mountPath: /opt/cardano/data
        - name: charlie-db-sync
          image: inputoutput/cardano-db-sync:latest 
          env:
            - name: NETWORK
              value: "preview"
            - name: POSTGRES_HOST
              value: "localhost"
            - name: POSTGRES_PORT
              value: "5432"
          volumeMounts:
            - name: charlie-ipc
              mountPath: /node-ipc
            - name: charlie-postgres-run
              mountPath: /run/postgresql
            - name: charlie-secrets
              mountPath: /run/secrets
        - name: charlie-postgres
          image: postgres:15.3
          ports:
            - containerPort: 5432
              protocol: TCP
          env:
            - name: POSTGRES_PASSWORD
              value: "password123"
            - name: POSTGRES_HOST_AUTH_METHOD
              value: "trust"
            - name: POSTGRES_DB
              value: "cexplorer"
          volumeMounts:
            - name: charlie-data
              mountPath: /var/lib/postgresql/data
            - name: charlie-postgres-run
              mountPath: /run/postgresql
        - name: charlie-bridge-backend
          image: 689191102645.dkr.ecr.eu-central-1.amazonaws.com/bridge-backend
          volumeMounts:
          - name: charlie-ipc
            mountPath: /node-ipc
          - name: charlie-data
            mountPath: /var/lib/postgresql/data
        - name: charlie-substrate-node
          image: 689191102645.dkr.ecr.eu-central-1.amazonaws.com/sidechains-substrate-node
          args: 
             - "--name"
             - "charlie"
             - "--base-path"
             - "/data/charlie"
             - "--chain"
             - "local"
             - "--validator"
             - "--node-key"
             - "0000000000000000000000000000000000000000000000000000000000000001"
          ports:
             - containerPort: 30333
               name: p2p
             - containerPort: 9945
               name: ws-port
             - containerPort: 9933
               name: rcp-port
          volumeMounts:
             - name: charlie-data
               mountPath: /data
        - name: charlie-vector
          image: timberio/vector:nightly-alpine
          ports:
            - containerPort: 8686 
          volumeMounts:
            - name: charlie-vector-config
              mountPath: /etc/vector
            - name: charlie-vector-logs
              mountPath: /var/log
      volumes:
        - name: charlie-data
          emptyDir: {}
        - name: charlie-ipc
          emptyDir: {}
        - name: charlie-postgres-run
          emptyDir: {}
        - name: charlie-secrets
          configMap:
            name: charlie-secrets
        - name: charlie-vector-config
          configMap:
            name: charlie-vector-config
        - name: charlie-vector-logs
          emptyDir: {}
